<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Персональний кабінет</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>Персональний кабінет</h2>
    <input type="text" id="studentInput" placeholder="Введіть ім’я…" autocomplete="off">
    <div id="suggestions"></div>
    <button class="action" onclick="loadDashboard()">Відкрити кабінет</button>
    <div id="dashboard" style="display:none">
      <div class="tab-buttons">
        <button id="tabInfo" onclick="showTab('info')" class="active">Абонементи</button>
        <button id="tabHistory" onclick="showTab('history')">Мої записи</button>
      </div>
      <div class="info" id="infoTab"></div>
      <div class="history" id="historyTab"></div>
    </div>
  </div>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzuqA5rdnQGeQ7M_bTlPUf3FJkingapuxIamP0LFYeWrUeJRmzi_zCtt2kLngKwCB6GMw/exec";
    let allNames = [];

    async function loadNames() {
      const res = await fetch(API_URL + "?action=names");
      allNames = await res.json();
    }

    window.onload = () => {
      loadNames();
      const input = document.getElementById('studentInput');
      input.addEventListener('input', onType);
      input.addEventListener('focus', onFocus);
      document.addEventListener('click', e => {
        if (!e.target.closest('#studentInput') && !e.target.closest('#suggestions')) {
          document.getElementById('suggestions').innerHTML = '';
        }
      });
    };

    function onType(e) {
      const val = e.target.value.toLowerCase().trim();
      showSuggestions(val);
    }

    function onFocus() {
      const val = document.getElementById('studentInput').value.toLowerCase().trim();
      showSuggestions(val);
    }

    function showSuggestions(filterText) {
      const sugg = document.getElementById('suggestions');
      sugg.innerHTML = '';
      let filtered = allNames;
      if (filterText) {
        filtered = allNames.filter(name => name.toLowerCase().includes(filterText));
      }
      filtered.slice(0, 20).forEach(name => {
        const div = document.createElement('div');
        div.textContent = name;
        div.className = 'suggestion';
        div.onclick = () => {
          document.getElementById('studentInput').value = name;
          sugg.innerHTML = '';
        };
        sugg.appendChild(div);
      });
    }

    async function loadDashboard() {
    const name = document.getElementById('studentInput').value.trim();
    if (!name) return alert('Введіть ім’я');

    const button = document.querySelector('.action');
    button.classList.add('loading');

    document.getElementById('infoTab').innerHTML = '';
    document.getElementById('historyTab').innerHTML = '';
    document.getElementById('dashboard').style.display = 'block';
    showTab('info');

    try {
      const infoRes = await fetch(API_URL + "?action=info&name=" + encodeURIComponent(name));
      const data = await infoRes.json();

      const now = new Date();
      const formatted = now.toLocaleString('uk-UA', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });

      document.getElementById('infoTab').innerHTML =
        `<b>Стан абонементу на ${formatted}</b><br><br>
         <b>Ім’я:</b> ${data.name}<br>
         <b>Групових тренувань:</b> ${data.groupTrainings}<br>
         <b>Індивідуальних тренувань:</b> ${data.individualTrainings}<br>
         <b>Оренда малого залу:</b> ${data.smallHallRent}<br>
         <b>Депозит:</b> ${Number(data.deposit).toLocaleString('uk-UA')} грн`;

      const scheduleRes = await fetch(API_URL + "?action=schedule&name=" + encodeURIComponent(name));
      const records = await scheduleRes.json();

      const historyDiv = document.getElementById('historyTab');
      historyDiv.innerHTML = '';

      if (records.future.length > 0) {
        historyDiv.innerHTML += `<h3>Майбутні записи</h3>` +
          records.future.map(r => `
              <div class="session-card">
                <div><b>Дата:</b> ${r.date}</div>
                <div><b>Тип:</b> ${r.type}</div>
                <div><b>Тренер:</b> ${r.coach}</div>
                <div><b>Зал:</b> ${r.hall}</div>
              </div>`).join('');
      }

      if (records.past.length > 0) {
        historyDiv.innerHTML += `<h3>Попередні записи</h3>` +
          records.past.map(r => `
              <div class="session-card">
                <div><b>Дата:</b> ${r.date}</div>
                <div><b>Тип:</b> ${r.type}</div>
                <div><b>Тренер:</b> ${r.coach}</div>
                <div><b>Зал:</b> ${r.hall}</div>
              </div>`).join('');
      }

      if (records.future.length === 0 && records.past.length === 0) {
        historyDiv.innerHTML = '<b>Занять не знайдено.</b>';
      }
    } catch (e) {
      alert("Помилка при завантаженні");
    } finally {
      button.classList.remove('loading');
    }
  }

    function showTab(tab) {
      document.getElementById("tabInfo").classList.remove("active");
      document.getElementById("tabHistory").classList.remove("active");
      document.getElementById("infoTab").style.display = "none";
      document.getElementById("historyTab").style.display = "none";

      if (tab === "info") {
        document.getElementById("tabInfo").classList.add("active");
        document.getElementById("infoTab").style.display = "block";
      } else {
        document.getElementById("tabHistory").classList.add("active");
        document.getElementById("historyTab").style.display = "block";
      }
    }
  </script>
</body>
</html>
